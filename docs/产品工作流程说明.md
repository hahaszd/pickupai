# PickupAI — 产品工作流程与架构说明

本文档详细介绍产品从头到尾的完整工作流程，包括如何为新 Tradie（手艺人/技工）开户，每通来电如何被自动处理，以及 Tradie 如何在事后查看客户信息。

---

## 整体流程概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Tradie 注册与配置                            │
│  管理员创建账户 → Tradie 设置呼叫转接 →                              │
│  AI 人设配置完毕 → Twilio 号码绑定                                   │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           实时来电处理                               │
│  客户来电 → 转接至 PickupAI → AI 实时接听 →                         │
│  收集客户信息 → 存入数据库 → 短信发送给 Tradie                       │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          Tradie 跟进处理                             │
│  Tradie 读取短信 → 登录管理后台 → 查看线索 →                        │
│  更新工单状态 → 回拨客户电话                                         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 第一阶段 — Tradie 注册与初始配置

### 1.1 需要从 Tradie 处收集的信息

开户前，我们需要向 Tradie 收集以下信息：

| 字段 | 示例 | 用途 |
|---|---|---|
| **公司名称** | "Mike's Plumbing" | 用于 AI 问候语 |
| **AI 接待员姓名** | "Olivia" | 个性化来电体验 |
| **服务类型** | "水管工, 燃气工" | 决定 AI 提问哪些具体问题 |
| **服务区域** | "悉尼市区，帕拉马塔50公里以内" | AI 婉拒区域外来电 |
| **手机号码**（接收短信） | `+61 412 000 000` | 每通来电后接收客户摘要 |
| **Twilio 号码**（分配给该 Tradie） | `+61 468 000 835` | 客户来电转接的目标号码 |
| **邮箱 + 密码** | — | 登录管理后台 |

### 1.2 管理员创建租户账户

管理员通过受保护的 Admin API 为 Tradie 创建账户：

```
POST /admin/tenants
Authorization: Bearer <ADMIN_TOKEN>

{
  "name": "Mike's Plumbing",
  "ai_name": "Olivia",
  "phone_number": "+61468000835",   ← 分配给该 Tradie 的 Twilio 号码
  "owner_phone": "+61412000000",    ← Tradie 的个人手机（接收短信）
  "trade_type": "plumber,gasfitter",
  "service_area": "Sydney metro, within 50km of Parramatta"
}
```

系统会自动完成：
- 在数据库中创建该租户记录
- 存储加密后的登录密码
- 将 Twilio 号码与该租户关联，确保来电路由正确

### 1.3 Tradie 设置呼叫转接

Tradie 保留自己现有的业务号码不变，只需配置**无人接听时自动转接**到 PickupAI 的 Twilio 号码。

**工作原理：**
- 客户拨打 Tradie 的常用号码
- 电话正常响铃约 20 秒
- 若无人接听 → 运营商自动静默转接到 Twilio 号码
- PickupAI 代替 Tradie 接听电话

**设置方式（澳大利亚手机）：**
```
拨号：**61*+61XXXXXXXXX*11*20#
```
*（详细的各运营商设置步骤请参见 `tradie-setup-guide.md`）*

---

## 第二阶段 — 来电实时处理

### 2.1 来电到达 Twilio

当电话打到 PickupAI 的 Twilio 号码时，Twilio 会向服务器发送一个 Webhook 请求：

```
POST /twilio/voice/incoming
```

服务器随后执行以下步骤：
1. 根据被拨号码（如 `+61468000835`）查找对应的 Tradie 租户
2. 加载该租户的完整配置（名称、AI 名称、服务类型、服务区域等）
3. 查询该来电号码是否有历史通话记录
4. 返回 TwiML 指令，让 Twilio 开启一条**媒体流 WebSocket** 连接回服务器

```xml
<Response>
  <Connect>
    <Stream url="wss://your-server.com/media-stream?callSid=CA..."/>
  </Connect>
</Response>
```

### 2.2 实时音频桥接

媒体流建立后，服务器充当 Twilio 与 OpenAI 之间的**实时音频桥**：

```
Twilio（来电音频）←──WebSocket──→ PickupAI 服务器 ←──WebSocket──→ OpenAI Realtime API
       μ-law 8kHz 编码                                               PCM 24kHz 编码
```

音频数据包在两个方向上实时流动：
- 来电者的声音 → 编码 → 发送给 OpenAI
- OpenAI 的 AI 语音回复 → 解码 → 发回给来电者

### 2.3 系统提示词动态构建

在连接 OpenAI 之前，服务器会根据该 Tradie 的具体配置**动态生成系统提示词（System Prompt）**，内容包括：

**a) 业务身份设定**
```
You are Olivia, a friendly AI receptionist for Mike's Plumbing.
（你是 Olivia，Mike's Plumbing 的 AI 接待员，态度友好亲切。）
```

**b) 行业专属问题**

根据 `trade_type` 的设置，AI 会提问对应的专业问题。以水管工为例：
- 问题发生的位置（厨房、浴室、热水系统等）
- 是否紧急 / 是否正在漏水
- 是自住房还是租住房

以电工为例：
- 安全确认（是否断电？有无焦糊气味？有无火花？）
- 工作类型（故障排查、新安装、检查、配电箱）
- 物业类型

若是多类型服务（如 "水管工 + 电工"），系统会自动合并两个行业的相关问题。

**c) 来电历史记录**

若该来电号码有历史记录，提示词中会包含：
```
该来电者曾联系过我们，历史通话记录如下：
- 2025-06-01：漏水龙头维修 — 已预约并完成
```
AI 可以温暖地问候回头客，无需重复询问已有的基本信息。

**d) 服务区域规则**

```
服务区域：悉尼市区，帕拉马塔50公里以内。
若来电者位于服务区域外：礼貌道歉，解释无法提供服务，祝他顺利找到附近的师傅。
仍需收集姓名和问题描述，以备将来情况有变。
```

**e) 来电场景应对方案**

AI 经过专门训练，能够妥善处理各类来电：
- 新工作询价
- 已有工作的跟进
- 投诉
- 改期请求
- 仅询问报价
- 打错电话、骚扰电话、推销电话
- 求职者、供应商来电
- 无声电话或粗鲁来电者

### 2.4 AI 对话过程

OpenAI Realtime API（模型：`gpt-realtime-mini-2025-12-15`）负责以下所有环节：
- **语音转文字**（实时转录来电者说话内容）
- **语义理解**（意图识别、情绪判断、紧急程度评估）
- **对话生成**（自然流畅的澳洲口音英语回复）
- **文字转语音**（语音：`marin`，低延迟）
- **语音活动检测（Semantic VAD）**（判断来电者是否说完，支持打断对话）

当 AI 收集到足够信息后，会自动调用**函数工具**保存数据：

```json
{
  "function": "save_lead",
  "arguments": {
    "caller_name": "Sarah",
    "address": "12 Main St, Parramatta NSW 2150",
    "issue": "厨房水槽下方水管爆裂，正在漏水",
    "urgency": "emergency",
    "preferred_time": "尽快"
  }
}
```

### 2.5 线索保存至数据库

收到 `save_lead` 指令后，服务器会：
1. 在 SQLite 数据库中创建或更新对应租户的 `leads`（线索）记录
2. 创建或更新 `calls`（通话）记录，包含完整对话文字记录和元数据
3. 将线索状态设置为 `new`（新线索）

### 2.6 短信通知发送给 Tradie

通话结束后数秒内，系统自动向 Tradie 的手机发送短信：

```
📞 新线索 — Mike's Plumbing

来电者：Sarah（+61400123456）
地址：12 Main St, Parramatta NSW 2150
问题：厨房水槽下方水管爆裂 — 紧急
期望时间：尽快

登录查看详情：https://your-server.com/dashboard
```

紧急来电会在短信中明确标注，让 Tradie 第一时间判断优先级。

---

## 第三阶段 — Tradie 查看与跟进线索

### 3.1 短信通知

每通来电结束后，Tradie 即时收到短信，短信提供：
- 足够判断优先级的关键信息
- 来电者的手机号码（可直接回拨）
- 管理后台链接（查看完整详情）

### 3.2 登录管理后台

**后台地址：** `https://your-server.com/dashboard/login`

Tradie 使用邮箱和密码登录，系统通过 HTTP-only 安全 Cookie 维持登录状态。

### 3.3 线索列表页

后台展示该 Tradie 账户下的所有线索，按时间倒序排列：

| 线索 | 来电者 | 地址 | 问题 | 状态 | 时间 |
|---|---|---|---|---|---|
| 🔴 紧急 | Sarah | 12 Main St, Parramatta | 水管爆裂 | 新线索 | 刚刚 |
| 🟡 | John | 45 Oak Ave, Penrith | 下水道堵塞 | 新线索 | 2小时前 |
| ✅ | Maria | 8 Hill Rd, Blacktown | 热水系统 | 已预约 | 昨天 |

### 3.4 线索详情页

点击任意线索可查看完整记录：
- 来电者姓名、手机号码、完整地址
- 问题详细描述
- 紧急程度
- 期望回电时间
- **通话录音**（可在浏览器中直接播放）
- **通话文字记录**（完整对话文本）
- 状态更新操作按钮

### 3.5 线索状态管理

Tradie 可将每条线索标记为以下状态：

| 状态 | 含义 |
|---|---|
| `new` | 新线索，尚未处理 |
| `called_back` | 已回拨客户电话 |
| `booked` | 工作已预约排期 |
| `handled` | 工作已完成或已关闭 |

### 3.6 CSV 导出

后台提供**下载 CSV**按钮，可将所有线索导出为电子表格，方便导入 Excel、Google Sheets 或 ServiceM8、Tradify 等工单管理软件。

---

## 数据库结构

```
tenants（租户表）
  └── tenant_id（主键）
  └── name（公司名）, ai_name（AI名称）, phone_number（Twilio号）, owner_phone（手机号）
  └── trade_type（服务类型）, service_area（服务区域）
  └── password_hash（密码哈希）, session_token（会话令牌）

calls（通话记录表）
  └── call_sid（Twilio 通话唯一标识）
  └── tenant_id（外键 → tenants）
  └── from_number（来电号码）, to_number（接收号码）
  └── transcript（完整对话文本）
  └── recording_url（录音链接）
  └── call_status（通话状态）, started_at（开始时间）, ended_at（结束时间）

leads（线索表）
  └── lead_id（主键）
  └── call_sid（外键 → calls）
  └── tenant_id（外键 → tenants）
  └── caller_name（来电者姓名）, address（地址）, issue_description（问题描述）
  └── urgency（紧急程度）, caller_intent（来电意图）, preferred_time（期望时间）
  └── lead_status（线索状态：new / called_back / booked / handled）
  └── created_at（创建时间）

notifications（通知记录表）
  └── 所有已发送短信的日志记录
```

---

## 安全机制

| 防护措施 | 实现方式 |
|---|---|
| Webhook 合法性验证 | 每条请求都验证 Twilio 数字签名 |
| Admin API 保护 | 所有 `/admin/*` 路由需携带 Bearer Token（`ADMIN_TOKEN`） |
| 后台会话管理 | HTTP-only Cookie 存储 UUID 会话令牌，并写入数据库 |
| 密码安全 | 使用 `pbkdf2Sync` 加盐哈希存储 |
| 多租户数据隔离 | 所有查询均按 `tenant_id` 过滤，租户之间数据完全独立 |

---

## 技术栈

| 层级 | 技术 |
|---|---|
| **电话接入** | Twilio Voice + Media Streams |
| **AI 语音引擎** | OpenAI Realtime API（`gpt-realtime-mini-2025-12-15`） |
| **后端服务** | Node.js + Express + TypeScript |
| **WebSocket 桥接** | `ws` 包 |
| **数据库** | SQLite（通过 `sql.js` WASM 方式，无需原生依赖） |
| **短信发送** | Twilio Programmable Messaging |
| **管理后台** | 服务端渲染 HTML（内置于 Express） |
| **部署方式** | Docker / Railway.app |
| **本地开发隧道** | ngrok |

---

## 响应延迟分析

一次典型对话交互的延迟分解：

| 阶段 | 耗时 |
|---|---|
| 来电者说话 → 音频到达 OpenAI | 约 100–200ms（Twilio + 网络传输） |
| OpenAI 处理并开始生成回复 | 约 300–700ms（Realtime API 处理） |
| 第一段音频回传给来电者 | 约 200ms |
| **来电者感知到的总响应时间** | **约 600ms–1秒** |

这与真人接待员的响应速度相当，相比之前基于 HTTP Chat Completions 的方案（每轮对话需要 5–15 秒）有了质的飞跃。

---

## 部署方式概述

服务器有两种运行模式：

- **本地开发**：执行 `npm run dev`，配合 ngrok 隧道将 Webhook 暴露给 Twilio
- **生产环境**：以 Docker 容器形式部署在 Railway.app 上（详见 `DEPLOY.md`）

所需环境变量：

```env
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...
OPENAI_API_KEY=...
OPENAI_VOICE=marin
ADMIN_TOKEN=...
PUBLIC_BASE_URL=https://your-production-domain.com
PORT=3000
```

---

*Tradie 端的配置操作说明请参见 `tradie-setup-guide.md`*
*服务器部署说明请参见 `DEPLOY.md`*
